# 开发规范文档

## 1. 背景
为了进一步规范代码开发，提升代码质量，特拟订一系列开发规范。包括代码格式化、静态检查、提交前检查、Git Commit 规范、Dockerfile 编写、可观测性集成等。

## 2. 代码格式化

### Python 项目 (负责人: @蔡跃亮)
工具：**Ruff**
文档：[Ruff Docs](https://docs.astral.sh/ruff/)

最佳实践：
- 本地开发用 VSCode + Ruff 插件（保存时格式化）。
- 提交代码靠 pre-commit 自动运行 Ruff 检查+修复。
- CI流程再跑一次 pre-commit run --all-files 确保万无一失。

配置文件：`.ruff.toml` 或 `pyproject.toml`

**推荐配置示例：**

```toml
exclude = [
    "migrations/*",
    "core/tools/builtin_tool/*",
]
line-length = 120

[format]
quote-style = "double"

[lint]
preview = false
select = [
    "B", # flake8-bugbear rules
    "C4", # flake8-comprehensions
    "E", # pycodestyle E rules
    "F", # pyflakes rules
    "FURB", # refurb rules
    "I", # isort rules
    "N", # pep8-naming
    "PT", # flake8-pytest-style rules
    "PLC0208", # iteration-over-set
    "PLC0414", # useless-import-alias
    "PLE0604", # invalid-all-object
    "PLE0605", # invalid-all-format
    "PLR0402", # manual-from-import
    "PLR1711", # useless-return
    "PLR1714", # repeated-equality-comparison
    "RUF013", # implicit-optional
    "RUF019", # unnecessary-key-check
    "RUF100", # unused-noqa
    "RUF101", # redirected-noqa
    "RUF200", # invalid-pyproject-toml
    "RUF022", # unsorted-dunder-all
    "S506", # unsafe-yaml-load
    "SIM", # flake8-simplify rules
    "TRY400", # error-instead-of-exception
    "TRY401", # verbose-log-message
    "UP", # pyupgrade rules
    "W191", # tab-indentation
    "W605", # invalid-escape-sequence
    # security related linting rules
    # RCE proctection (sort of)
    "S102", # exec-builtin, disallow use of `exec`
    "S307", # suspicious-eval-usage, disallow use of `eval` and `ast.literal_eval`
    "S301", # suspicious-pickle-usage, disallow use of `pickle` and its wrappers.
    "S302", # suspicious-marshal-usage, disallow use of `marshal` module
    "S311", # suspicious-non-cryptographic-random-usage
]

ignore = [
    "E402", # module-import-not-at-top-of-file
    "E711", # none-comparison
    "E712", # true-false-comparison
    "E721", # type-comparison
    "E722", # bare-except
    "F821", # undefined-name
    "F841", # unused-variable
    "FURB113", # repeated-append
    "FURB152", # math-constant
    "UP007", # non-pep604-annotation
    "UP032", # f-string
    "UP045", # non-pep604-annotation-optional
    "B005", # strip-with-multi-characters
    "B006", # mutable-argument-default
    "B007", # unused-loop-control-variable
    "B026", # star-arg-unpacking-after-keyword-arg
    "B903", # class-as-data-structure
    "B904", # raise-without-from-inside-except
    "B905", # zip-without-explicit-strict
    "N806", # non-lowercase-variable-in-function
    "N815", # mixed-case-variable-in-class-scope
    "PT011", # pytest-raises-too-broad
    "SIM102", # collapsible-if
    "SIM103", # needless-bool
    "SIM105", # suppressible-exception
    "SIM107", # return-in-try-except-finally
    "SIM108", # if-else-block-instead-of-if-exp
    "SIM113", # enumerate-for-loop
    "SIM117", # multiple-with-statements
    "SIM210", # if-expr-with-true-false
]

[lint.per-file-ignores]
"__init__.py" = [
    "F401", # unused-import
    "F811", # redefined-while-unused
]
"configs/*" = [
    "N802", # invalid-function-name
]
"libs/gmpy2_pkcs10aep_cipher.py" = [
    "N803", # invalid-argument-name
]
"tests/*" = [
    "F811", # redefined-while-unused
]

[lint.pyflakes]
allowed-unused-imports = [
    "_pytest.monkeypatch",
    "tests.integration_tests",
    "tests.unit_tests",
]
```

## 3. 依赖管理规范

### Typescript 项目 (负责人: @何知庆)
*   **包管理器**:
    *   `pnpm`：生产环境首选
    *   `bun`：脚本/工具库/新演示项目 (可选)
*   **依赖分类**:
    *   严谨区分 `dependencies` 和 `devDependencies`
*   **版本控制**:
    *   根据项目情况选择是否提交 lock 文件
    *   依赖版本号控制，一般使用 `~` 匹配最近的小版本依赖包

**核心 Registry 配置 (.npmrc):**

```ini
# ------------------------------------------------------------------------------
# 核心 Registry 配置
# ------------------------------------------------------------------------------
# 默认使用淘宝镜像源，加速国内访问
registry=https://registry.npmmirror.com

# Nvidia 私有域相关包配置
@nvidia:registry=https://edge.urm.nvidia.com:443/artifactory/api/npm/omniverse-client-npm/

# ------------------------------------------------------------------------------
# 二进制文件下载镜像配置 (加速编译型依赖下载)
# ------------------------------------------------------------------------------
# node-sass / sass
sass_binary_site=https://npmmirror.com/mirrors/node-sass/
# electron
electron_mirror=https://npmmirror.com/mirrors/electron/
# puppeteer / chrome
puppeteer_download_host=https://npmmirror.com/mirrors/
# sharp (高性能图片处理库)
sharp_binary_host=https://npmmirror.com/mirrors/sharp/
# sentry-cli
sentrycli_cdnurl=https://npmmirror.com/mirrors/sentry-cli/
# swc (Rust 编写的编译器)
swc_binary_site=https://npmmirror.com/mirrors/swc/
```

### Python 项目 (负责人: @蔡跃亮)
*   **包管理器**:
    *   新项目推荐使用 **Poetry** 或 **uv** 进行依赖管理和虚拟环境管理。
    *   传统项目可继续使用 `pip` + `requirements.txt`，必要时再进行升级。
*   **依赖分类**:
    *   区分 `main` (生产依赖) 和 `dev` (开发/测试依赖)。
    *   例如 Poetry 中使用 `[tool.poetry.dependencies]` 和 `[tool.poetry.dev.dependencies]`。
*   **镜像源配置**:
    *   推荐使用阿里云或清华源加速下载。
    ```bash
    # Poetry 配置示例
    poetry source add --priority=default aliyun https://mirrors.aliyun.com/pypi/simple/
    ```

## 4. 静态检查

### Python: Ruff (负责人: @蔡跃亮)
*   见“代码格式化”部分配置。
*   建议结合 `pre-commit` 使用。

### Go 项目 (负责人: @沈力)
*   (待补充 Go 相关静态检查工具，如 `golangci-lint`)

### Typescript 项目 (负责人: @何知庆)
*   工具：`tsc` + `biome`
*   **TypeScript 配置 (tsconfig.json):**

```json
{
  "include": ["**/*.ts", "**/*.tsx"],
  "compilerOptions": {
    "target": "ESNext",
    "jsx": "react-jsx",
    "module": "ESNext",
    "lib": ["ESNext", "DOM", "DOM.Iterable"],
    "types": ["vite/client"],

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "noEmit": true,

    /* Linting */
    "skipLibCheck": true,
    "strict": false,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

*   **Biome 配置 (biome.json):**

```json
{
  "$schema": "https://biomejs.dev/schemas/2.3.9/schema.json",
  "vcs": { "enabled": false, "clientKind": "git", "useIgnoreFile": false },
  "files": {
    "ignoreUnknown": false,
    "includes": [
      "**/src/**/*",
      "**/.vscode/**/*",
      "**/index.html",
      "**/vite.config.js"
    ]
  },
  "formatter": {
    "enabled": true,
    "formatWithErrors": true,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineEnding": "lf",
    "lineWidth": 80,
    "attributePosition": "auto",
    "bracketSameLine": false,
    "bracketSpacing": true,
    "expand": "auto",
    "useEditorconfig": true,
    "includes": [
      "**",
      "!**/build/",
      "!**/dist/",
      "!**/public/",
      "!**/node_modules/",
      "!**/local/",
      "!**/package-lock.json",
      "!**/yarn.lock",
      "!**/*.html"
    ]
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": false,
      "a11y": {
        "noStaticElementInteractions": "off",
        "noSvgWithoutTitle": "off",
        "useKeyWithClickEvents": "off"
      },
      "correctness": {
        "noChildrenProp": "off",
        "noInvalidUseBeforeDeclaration": "off",
        "noUnusedVariables": "off",
        "useExhaustiveDependencies": "off",
        "useUniqueElementIds": "off"
      },
      "style": { "noInferrableTypes": "off", "useConst": "off" },
      "suspicious": {
        "noArrayIndexKey": "off",
        "noEmptyBlockStatements": "off",
        "noExplicitAny": "off",
        "noImplicitAnyLet": "off",
        "useIterableCallbackReturn": "off"
      }
    }
  },
  "javascript": {
    "formatter": {
      "jsxQuoteStyle": "double",
      "quoteProperties": "asNeeded",
      "trailingCommas": "all",
      "semicolons": "asNeeded",
      "arrowParentheses": "asNeeded",
      "bracketSameLine": false,
      "quoteStyle": "single",
      "attributePosition": "auto",
      "bracketSpacing": true
    }
  },
  "html": {
    "formatter": {
      "indentScriptAndStyle": false,
      "selfCloseVoidElements": "always"
    }
  },
  "assist": {
    "enabled": true,
    "actions": { "source": { "organizeImports": "off" } }
  }
}
```

## 5. 单元测试

### Python 项目 (负责人: @蔡跃亮)
*   **测试框架**: 推荐使用 `pytest`。
*   **目录结构**: 测试代码统一放在项目根目录下的 `tests/` 文件夹中。
*   **命名规范**:
    *   测试文件以 `test_` 开头或 `_test.py` 结尾。
    *   测试类以 `Test` 开头。
    *   测试函数以 `test_` 开头。
*   **覆盖率**: 使用 `pytest-cov` 检查代码覆盖率，核心模块建议覆盖率达到 80% 以上。

## 6. 提交前检查 (Pre-commit)

**工具**:
*   [lefthook](https://github.com/evilmartians/lefthook)
*   [pre-commit](https://pre-commit.com/)

**配置示例 (.pre-commit-config.yaml):**

```yaml
default_language_version:
    python: python3.11
repos:
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
    -   id: check-added-large-files
    -   id: check-yaml
        args:
        -   --unsafe
    -   id: end-of-file-fixer
    -   id: trailing-whitespace
    -   id: requirements-txt-fixer
-   repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.14.10
    hooks:
    -   id: ruff-check
        args: [ --fix ]
    -   id: ruff-format
```

## 7. 代码流程规范

**工具**: [git-flow-next](https://git-flow.sh/docs/)

### 模式一: Git Flow
**适用场景**: 业务平台（训推平台、应用开发）

| 分支类型 | 起源分支 (Parent) | 合并回分支 (Merge to) | 用途说明 |
| :--- | :--- | :--- | :--- |
| **main** | - | - | 生产环境代码，必须打 Tag。 |
| **develop** | main | - | 集成所有已完成的特性，下一次发布的基准。 |
| **feature/\*** | develop | develop | 开发新功能。 |
| **bugfix/\*** | develop | develop | 修复非生产环境的 Bug。 |
| **release/\*** | develop | main & develop | 发布前最后的润色与 Bug 修复，禁止加入新功能。 |
| **hotfix/\*** | main | main & develop | 修复线上紧急故障。 |
| **support/\*** | main | (自身维护) | 维护旧版本的补丁更新。 |

### 模式二: Github Flow
**适用场景**: 基础服务（casdoor、风控代理服务）

| 分支类型 | 起源分支 (Parent) | 合并回分支 (Merge to) | 用途说明 |
| :--- | :--- | :--- | :--- |
| **main** | - | - | 核心基准分支。始终保持稳定、已测试、可随时部署的状态。是唯一的真实来源（Source of Truth）。 |
| **feature/\*** | main | main | 主题分支。涵盖所有开发工作，包括新功能开发、代码重构、常规 Bug 修复。 |
| **(Pull Request)** | feature/\* | main | 代码审查机制。合并前的核心环节，用于进行同行评审、运行自动化测试（CI）并获取批准。 |

## 8. Git Commit 规范

采用 **Conventional Commits**（约定式提交）标准。

### 1. Commit Message 标准格式
```
<type>(<scope>): <subject>
// 空一行
<body>
// 空一行
<footer>
```
*   **Header (必须)**
    *   `type`: 本次提交的类型。
    *   `scope`: (可选) 受影响的范围（如：auth, database, ui）。
    *   `subject`: 简短描述，建议不超过 50 个字符。
*   **Body (可选)**: 详细描述本次修改的动机以及与之前版本的对比。
*   **Footer (可选)**: 关联 Issue 或声明 Breaking Change。

### 2. 常用 Type 类型详解

| 类型 (Type) | 场景描述 | 是否触发版本号更新 |
| :--- | :--- | :--- |
| **feat** | 新功能 (feature) | 是 (Minor) |
| **fix** | 修订 Bug (bug fix) | 是 (Patch) |
| **docs** | 仅修改文档 (documentation) | 否 |
| **style** | 格式变动（不影响代码运行的变动，如空格、分号等） | 否 |
| **refactor** | 重构（既不是新增功能，也不是修改 bug） | 否 |
| **perf** | 提高性能的修改 (performance) | 是 (Patch) |
| **test** | 增加或修改测试用例 | 否 |
| **build** | 影响构建系统或外部依赖的更改 (如：gulp, npm, webpack) | 否 |
| **ci** | 修改 CI 配置文件和脚本 | 否 |
| **chore** | 其他不修改 src 或测试文件的常规改动 | 否 |
| **revert** | 回滚到上一个版本 | 否 |

### 3. 工具链
*   **Commitizen**: 交互式命令行工具。
*   **Commitlint**: 检查提交消息格式。
*   **Husky**: Git Hooks 工具。
*   **standard-version**: 自动生成 CHANGELOG 和版本更新。

## 9. 代码审查（Code Review）规范
(建议制定 Code Review Checklist，包括代码逻辑、风格、测试覆盖率、安全性等方面)

## 10. 可观测性集成
*   **日志 (Logging)**: 必须包含时间戳、日志级别、模块名。
*   **追踪 (Trace)**: 关联 `trace id` 或 `request id`，实现全链路追踪。
*   **指标 (Metrics)**: 收集关键业务指标和系统性能指标。

## 11. 接口文档
*   统一使用 [Apifox](https://apifox.com/) 进行管理。

## 12. Dockerfile

### 通用规范
*   **代码加密**: 针对敏感代码进行混淆或加密处理。
*   **Base 镜像管理**: 尽量使用官方 Slim 版本或 Alpine 版本（需注意兼容性）。
*   **多阶段构建**: 减小最终镜像体积，分离构建环境和运行环境。

### Python 项目 (负责人: @蔡跃亮)
*   **基础镜像**: 推荐使用 `python:3.11-slim` 或 `python:3.11-alpine` (需谨慎处理 C 依赖)。
*   **优化**:
    *   设置环境变量 `PYTHONDONTWRITEBYTECODE=1` 避免生成 `.pyc` 文件。
    *   设置 `PYTHONUNBUFFERED=1` 确保日志实时输出。
*   **安全**: 创建非 root 用户运行应用。

```dockerfile
# 示例: 多阶段构建
# Build stage
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# Run stage
FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /root/.local /root/.local
COPY . .
ENV PATH=/root/.local/bin:$PATH
CMD ["python", "main.py"]
```
