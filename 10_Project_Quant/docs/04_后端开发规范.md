# 后端开发规范（Python / FastAPI）

## 代码风格
- 遵循 PEP8
- 命名：
  - 变量/函数：`snake_case`
  - 类：`CamelCase`
  - 常量：`UPPER_SNAKE_CASE`
- 新增业务代码必须写清晰 docstring（建议中文）

## 目录与职责（以当前结构为准）
- `api/main.py`：应用入口、路由注册、CORS、启动初始化
- `api/models.py`：SQLAlchemy 模型
- `api/schemas.py`：Pydantic 模型
- `api/crud.py`：数据访问与简单聚合（后续可演进为 repository/service 分层）
- `api/routers/*`：路由层（只做参数解析与权限校验，业务委托给 crud/services）
- `api/dependencies.py`：认证鉴权依赖（`get_current_user` / `get_current_admin_user`）
- `api/services/*`：第三方集成与领域服务（例如东方财富数据源）

## REST 端点模板（推荐写法）
```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from .. import database

router = APIRouter(prefix="/api/example", tags=["example"])


@router.get("/")
def list_items(skip: int = 0, limit: int = 20, db: Session = Depends(database.get_db)):
    """列表示例：只处理入参，业务放到 crud/service。"""
    return {"total": 0, "items": []}
```

## 鉴权规范
- 管理员接口必须依赖 `get_current_admin_user`
- 前端请求必须携带 `Authorization: Bearer <token>`

## 数据同步（基金净值）规范
- 数据源放在 `api/services/*`，只负责“拉取 + 解析 + 结构化”。
- 落库逻辑放在 `crud.upsert_*`，避免路由层写数据库细节。
- 同步接口应返回：
  - `inserted`：新增记录数
  - `details`：按基金拆分的同步结果

## 数据库与迁移
- 当前项目会在启动时 `create_all` 建表（适合 PoC）。
- 生产建议迁移到 Alembic：
  - 增量迁移、可审计、可回滚

## 测试
- 单元测试放在 `api/tests/`
- 新增数据源解析必须写解析测试（避免外部接口格式变动导致线上崩溃）

